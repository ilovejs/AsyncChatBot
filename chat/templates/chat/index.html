<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Chat Room</title>
    {% load static %}
    <link rel="stylesheet" media="all" type="text/css" href="{% static '/chat/style.css' %}">
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.3/jquery.mCustomScrollbar.concat.min.js"></script>
    <script type="text/javascript" src="{% static '/chat/chat.js' %}"></script>
</head>
<body>
    <div class="chat">
        <div class="chat-title">
            <h1>Mike Z</h1>
            <h2>Supah</h2>
            <figure class="avatar">
                <img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/156381/profile/profile-80.jpg" />
            </figure>
        </div>
        <!--panel-->
        <div class="messages">
            <div class="messages-content"></div>
        </div>
        <!--sender panel-->
        <div class="message-box">
            <textarea type="text" class="message-input" placeholder="Type message..."></textarea>
            <button type="submit" class="message-submit">Send</button>
        </div>

    </div>
    <div class="bg"></div>
</body>
<script>
    var messages = $(".messages-content"), d, h, m, i = 0;

    $(window).load(function () {        
        //mCustomScrollbar is function from jquery mCustomScrollbar plugin
        messages.mCustomScrollbar();

        setTimeout(function () {
            fakeMessage();
        }, 100);
    });

    var Fake = [
        'Hi there, I\'m Fabio and you?',
        'Nice to meet you',
        'How are you?',
        'Not too bad, thanks',
        'What do you do?',
        'That\'s awesome',
        'Codepen is a nice place to stay',
        'I think you\'re a nice person',
        'Why do you think that?',
        'Can you explain?',
        'Anyway I\'ve gotta go now',
        'It was a pleasure chat with you',
        'Time to make a new codepen',
        'Bye',
        ':)'
    ]

    function updateScrollbar() {
        //messages.mCustomScrollbar("update").mCustomScrollbar('scrollTo', 'bottom', {
        //    scrollInertia: 10,
        //    timeout: 0
        //});
    }
    
    function setDate() {
        d = new Date()
        if (m != d.getMinutes()) {
            m = d.getMinutes();
            $('<div class="timestamp">' + d.getHours() + ':' + m + '</div>').appendTo($('.message:last'));
        }
    }

    function insertMessage() {
        console.log('insert msg..')
        msg = $('.message-input').val();

        //when user stop typing
        if ( !$.trim(msg) ) {
            return false;
        }

        $('<div class="message message-personal">' + msg + '</div>').appendTo(
            $('.mCSB_container')
        ).addClass('new');
    
        setDate();

        $('.message-input').val(null);

        updateScrollbar();

        setTimeout(function () {
            fakeMessage();
        }, 1000 + (Math.random() * 20) * 100);
    }

    function fakeMessage() {
        console.log('fakeMessage')
        
        //if user typed some words
        if ($('.message-input').val() != '') {
            return false;
        }

        $('<div class="message loading new"><figure class="avatar"><img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/156381/profile/profile-80.jpg" /></figure><span></span></div>').appendTo($('.mCSB_container'));
        
        updateScrollbar();

        setTimeout(function () {
            $('.message.loading').remove();
            console.log('in a loop..')
            $('<div class="message new"><figure class="avatar"><img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/156381/profile/profile-80.jpg" /></figure>' + Fake[i] + '</div>').appendTo($('.mCSB_container')).addClass('new');
            
            setDate();

            updateScrollbar();
            i++;
        }, 1000 + (Math.random() * 20) * 100);
    }

    //connection
    var chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/');

    //append change log
    chatSocket.onmessage = function(e) {
        console.log('on-message event.')
        var data = JSON.parse(e.data);
        var message = data['message'];
        
        insertMessage();
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    var input_id = '.message-input';
    var submit_id = '.message-submit';
    
    //focus on textarea
    $(input_id).focus();

    $(input_id).keyup(function(e) {
        // enter, return
        if (e.keyCode === 13) {  
            console.log('keyboard submit');
            $(submit_id).click();
        }
    });

    //mouse click submit
    $(submit_id).click(function(e){
        console.log('client sending....');

        var messageInputDom = $(input_id);
        chatSocket.send(JSON.stringify({
            'message': messageInputDom.val()
        }));
        //
        insertMessage();
        //reset input area
        messageInputDom.val('');
    });
</script>
</html>